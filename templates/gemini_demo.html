<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Gemini Embeddings Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-block;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Google Gemini Embeddings Demo</h1>
            <p class="text-gray-200">Test and explore Google Gemini's powerful embedding capabilities</p>
        </div>

        <!-- Status Cards -->
        <div class="grid md:grid-cols-3 gap-4 mb-8">
            <div class="card rounded-lg p-4 shadow-lg">
                <h3 class="font-semibold text-gray-800 mb-2">API Key Status</h3>
                <p class="text-sm text-gray-600">{{ api_key_status }}</p>
            </div>
            <div class="card rounded-lg p-4 shadow-lg">
                <h3 class="font-semibold text-gray-800 mb-2">Embeddings</h3>
                <p class="text-sm text-gray-600">{{ embedding_status }}</p>
            </div>
            <div class="card rounded-lg p-4 shadow-lg">
                <h3 class="font-semibold text-gray-800 mb-2">Database</h3>
                <p class="text-sm text-gray-600">{{ db_status }}</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Embedding Test -->
            <div class="card rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üß™ Test Embeddings</h2>
                <div class="space-y-4">
                    <textarea 
                        id="embedding-text" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="3"
                        placeholder="Enter text to generate embeddings..."
                    >How to create a React component with modern styling?</textarea>
                    
                    <button 
                        id="test-embedding-btn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200"
                    >
                        Generate Embedding
                        <span class="loading ml-2">üîÑ</span>
                    </button>
                    
                    <div id="embedding-result" class="hidden p-4 bg-gray-50 rounded-lg">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Document Search -->
            <div class="card rounded-lg p-6 shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üîç Search Documents</h2>
                <div class="space-y-4">
                    <input 
                        id="search-query" 
                        type="text"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Search for documentation..."
                        value="React component best practices"
                    >
                    
                    <div class="flex space-x-4">
                        <select id="tool-filter" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Tools</option>
                        </select>
                        <select id="result-count" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="3">3 Results</option>
                            <option value="5" selected>5 Results</option>
                            <option value="10">10 Results</option>
                        </select>
                    </div>
                    
                    <button 
                        id="search-btn"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200"
                    >
                        Search Documents
                        <span class="loading ml-2">üîÑ</span>
                    </button>
                    
                    <div id="search-results" class="hidden">
                        <!-- Search results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Provider Info -->
        <div class="card rounded-lg p-6 shadow-lg mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚ÑπÔ∏è Provider Information</h2>
            <div id="provider-info" class="text-gray-600">
                Loading provider information...
            </div>
        </div>

        <!-- Instructions -->
        <div class="card rounded-lg p-6 shadow-lg mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìñ Instructions</h2>
            <div class="text-gray-600 space-y-2">
                <p><strong>Embedding Test:</strong> Enter any text to see how Gemini converts it into numerical vectors for semantic search.</p>
                <p><strong>Document Search:</strong> Search through AI tool documentation using semantic similarity rather than keyword matching.</p>
                <p><strong>Provider Info:</strong> View details about the current embedding model and configuration.</p>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const embeddingBtn = document.getElementById('test-embedding-btn');
        const embeddingText = document.getElementById('embedding-text');
        const embeddingResult = document.getElementById('embedding-result');
        const searchBtn = document.getElementById('search-btn');
        const searchQuery = document.getElementById('search-query');
        const toolFilter = document.getElementById('tool-filter');
        const resultCount = document.getElementById('result-count');
        const searchResults = document.getElementById('search-results');
        const providerInfo = document.getElementById('provider-info');

        // Utility functions
        function showLoading(button) {
            button.disabled = true;
            button.querySelector('.loading').classList.add('active');
        }

        function hideLoading(button) {
            button.disabled = false;
            button.querySelector('.loading').classList.remove('active');
        }

        function showError(element, message) {
            element.innerHTML = `<div class="p-3 bg-red-100 border border-red-400 text-red-700 rounded">${message}</div>`;
            element.classList.remove('hidden');
        }

        // Test embedding functionality
        embeddingBtn.addEventListener('click', async () => {
            const text = embeddingText.value.trim();
            if (!text) {
                showError(embeddingResult, 'Please enter some text to embed.');
                return;
            }

            showLoading(embeddingBtn);

            try {
                const response = await fetch('/test_embedding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                const data = await response.json();

                if (data.success) {
                    embeddingResult.innerHTML = `
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Embedding Generated Successfully!</h4>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <strong>Text:</strong><br>
                                    <span class="text-gray-600">"${data.text.substring(0, 100)}${data.text.length > 100 ? '...' : ''}"</span>
                                </div>
                                <div>
                                    <strong>Dimension:</strong> ${data.embedding_dimension}<br>
                                    <strong>Provider:</strong> ${data.provider_info.provider}<br>
                                    <strong>Model:</strong> ${data.provider_info.model}
                                </div>
                            </div>
                            <div>
                                <strong>Preview (first 5 values):</strong><br>
                                <code class="text-xs">[${data.embedding_preview.map(v => v.toFixed(6)).join(', ')}...]</code>
                            </div>
                        </div>
                    `;
                    embeddingResult.classList.remove('hidden');
                } else {
                    showError(embeddingResult, data.error || 'Failed to generate embedding');
                }
            } catch (error) {
                showError(embeddingResult, 'Network error: ' + error.message);
            } finally {
                hideLoading(embeddingBtn);
            }
        });

        // Search documents functionality
        searchBtn.addEventListener('click', async () => {
            const query = searchQuery.value.trim();
            if (!query) {
                showError(searchResults, 'Please enter a search query.');
                return;
            }

            showLoading(searchBtn);

            try {
                const response = await fetch('/search_documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        tool_filter: toolFilter.value || null,
                        n_results: parseInt(resultCount.value)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.results.length === 0) {
                        searchResults.innerHTML = '<div class="p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded">No documents found matching your query.</div>';
                    } else {
                        let resultsHtml = `
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-800">Found ${data.results_count} results for "${data.query}"</h4>
                        `;
                        
                        data.results.forEach(result => {
                            resultsHtml += `
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-sm font-medium text-blue-600">#${result.rank}</span>
                                        ${result.distance ? `<span class="text-xs text-gray-500">Distance: ${result.distance.toFixed(4)}</span>` : ''}
                                    </div>
                                    <p class="text-sm text-gray-700 mb-2">${result.content}</p>
                                    <div class="text-xs text-gray-500">
                                        Tool: ${result.metadata.tool_name || 'Unknown'} | 
                                        Type: ${result.metadata.file_type || 'Unknown'}
                                    </div>
                                </div>
                            `;
                        });
                        
                        resultsHtml += '</div>';
                        searchResults.innerHTML = resultsHtml;
                    }
                    searchResults.classList.remove('hidden');
                } else {
                    showError(searchResults, data.error || 'Search failed');
                }
            } catch (error) {
                showError(searchResults, 'Network error: ' + error.message);
            } finally {
                hideLoading(searchBtn);
            }
        });

        // Load provider information on page load
        async function loadProviderInfo() {
            try {
                const response = await fetch('/get_provider_info');
                const data = await response.json();
                
                if (data.success) {
                    const info = data.provider_info;
                    providerInfo.innerHTML = `
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div><strong>Provider:</strong> ${info.provider}</div>
                            <div><strong>Model:</strong> ${info.model}</div>
                            <div><strong>Task Type:</strong> ${info.task_type}</div>
                            <div><strong>Dimensions:</strong> ${info.dimensions || 'Auto'}</div>
                        </div>
                    `;
                } else {
                    providerInfo.innerHTML = `<span class="text-red-600">Error loading provider info: ${data.error}</span>`;
                }
            } catch (error) {
                providerInfo.innerHTML = `<span class="text-red-600">Network error: ${error.message}</span>`;
            }
        }

        // Load available tools for filtering
        async function loadAvailableTools() {
            try {
                const response = await fetch('/get_available_tools');
                const data = await response.json();
                
                if (data.success && data.tools.length > 0) {
                    data.tools.forEach(tool => {
                        const option = document.createElement('option');
                        option.value = tool;
                        option.textContent = tool.charAt(0).toUpperCase() + tool.slice(1);
                        toolFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.log('Could not load tools:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadProviderInfo();
            loadAvailableTools();
        });
    </script>
</body>
</html>
